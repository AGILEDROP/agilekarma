version: '3'

services:
  traefik:
    image: traefik:1.6.6-alpine
    container_name: ${PROJECT_NAME}_traefik
    command: --docker
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.toml:/traefik.toml
      - ./traefik/.certs:/certs
    networks:
      - proxy
    labels:
      - 'traefik.frontend.rule=Host:monitor.localhost'
      - 'traefik.port=8080'

  nodejs:
    image: node:10
    working_dir: /home/node/app
    container_name: ${PROJECT_NAME}_nodejs
    environment:
      NODE_ENV: production
      SLACK_BOT_USER_OAUTH_ACCESS_TOKEN: ${SLACK_BOT_USER_OAUTH_ACCESS_TOKEN}
      SLACK_VERIFICATION_TOKEN: ${SLACK_VERIFICATION_TOKEN}
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
    command: "node index.js"
    restart: unless-stopped
    depends_on:
      - mysql
    volumes:
      - ./:/home/node/app
    expose:
      - "80"
    labels:
      - 'traefik.frontend.rule=Host:${PROJECT_HOSTNAME},www.${PROJECT_HOSTNAME}'
      - 'traefik.docker.network=proxy'
    networks:
      - proxy
      - default
  mysql:
    image: mysql
    container_name: ${PROJECT_NAME}_mysql
    command: --default-authentication-plugin=mysql_native_password
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DATABASE_NAME}
      MYSQL_USER: ${DATABASE_USER}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD}
      MYSQL_PORT: 3306
    volumes:
      - ./mysql:/var/lib/mysql
    networks:
      - default
  adminer:
    image: adminer
    container_name: ${PROJECT_NAME}_adminer
    restart: always
    ports:
      - 8080:8080
  ngrok:
    image: shkoliar/ngrok:latest
    container_name: ${PROJECT_NAME}_ngrok
    ports:
      - 4551:4551
    links:
      - nodejs
    environment:
      - DOMAIN=nodejs
      - PORT=80
      - REGION=eu

networks:
  default:
  proxy:
    external: true
